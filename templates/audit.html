<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/dark-theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }

        .card-header {
            font-size: 1.4em;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, #6a11cb, #2575fc) 1;
            padding-bottom: 12px;
            font-weight: 700;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: white;
            text-decoration: none;
            font-weight: 600;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters select, .filters input {
            padding: 10px;
            border: 2px solid #e3e6f0;
            border-radius: 10px;
            font-size: 14px;
        }

        .audit-table {
            width: 100%;
            border-collapse: collapse;
        }

        .audit-table th, .audit-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .audit-table th {
            background: #f1f1f1;
            font-weight: 700;
            color: #333;
        }

        .audit-table tr:hover {
            background: #f8f9fa;
        }

        .action-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .action-insert { background: #d4edda; color: #155724; }
        .action-update { background: #fff3cd; color: #856404; }
        .action-delete { background: #f8d7da; color: #721c24; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .diff-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .diff-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .diff-section h4 {
            margin-bottom: 10px;
            color: #6a11cb;
        }

        .diff-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
        }

        .diff-old {
            background: #f8d7da;
            color: #721c24;
        }

        .diff-new {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="content">
        <a href="/dashboard" class="back-link">
            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        </a>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            </div>

            <div class="filters">
                <select id="filter-table" onchange="loadAuditLogs()">
                    <option value="">–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã</option>
                    <option value="product">–¢–æ–≤–∞—Ä—ã</option>
                    <option value="orders">–ó–∞–∫–∞–∑—ã</option>
                    <option value="customer">–ö–ª–∏–µ–Ω—Ç—ã</option>
                    <option value="purchase">–ó–∞–∫—É–ø–∫–∏</option>
                    <option value="category">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    <option value="supplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏</option>
                </select>

                <select id="filter-action" onchange="loadAuditLogs()">
                    <option value="">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</option>
                    <option value="INSERT">–°–æ–∑–¥–∞–Ω–∏–µ</option>
                    <option value="UPDATE">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</option>
                    <option value="DELETE">–£–¥–∞–ª–µ–Ω–∏–µ</option>
                </select>

                <input type="number" id="filter-limit" placeholder="–õ–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π" value="100" onchange="loadAuditLogs()" style="width: 150px;">
            </div>

            <table class="audit-table" id="audit-table">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        <th>–¢–∞–±–ª–∏—Ü–∞</th>
                        <th>ID –∑–∞–ø–∏—Å–∏</th>
                        <th>IP</th>
                        <th>–î–µ—Ç–∞–ª–∏</th>
                    </tr>
                </thead>
                <tbody id="audit-body">
                    <tr><td colspan="7" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modal-title">–î–µ—Ç–∞–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è</h3>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        let allLogs = [];

        async function loadAuditLogs() {
            try {
                const limit = document.getElementById('filter-limit').value || 100;
                const response = await fetch(`/api/audit/?limit=${limit}`);
                if (response.ok) {
                    allLogs = await response.json();
                    filterAndRenderLogs();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
            }
        }

        function filterAndRenderLogs() {
            const tableFilter = document.getElementById('filter-table').value;
            const actionFilter = document.getElementById('filter-action').value;

            let filtered = allLogs;
            if (tableFilter) {
                filtered = filtered.filter(log => log.table_name === tableFilter);
            }
            if (actionFilter) {
                filtered = filtered.filter(log => log.action_type === actionFilter);
            }

            renderLogs(filtered);
        }

        function renderLogs(logs) {
            const tbody = document.getElementById('audit-body');
            tbody.innerHTML = '';

            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
                return;
            }

            logs.forEach(log => {
                const tr = document.createElement('tr');
                
                const date = new Date(log.created_at);
                const actionClass = log.action_type === 'INSERT' ? 'action-insert' : 
                                   log.action_type === 'UPDATE' ? 'action-update' : 'action-delete';

                tr.innerHTML = `
                    <td>${date.toLocaleString('ru-RU')}</td>
                    <td>${log.employee_name}</td>
                    <td><span class="action-badge ${actionClass}">${log.action_type}</span></td>
                    <td>${log.table_display || log.table_name}</td>
                    <td>${log.record_id || '-'}</td>
                    <td>${log.ip_address || '-'}</td>
                    <td><button class="btn btn-primary" onclick="showDetails(${log.log_id})">–ü–æ–∫–∞–∑–∞—Ç—å</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showDetails(logId) {
            const log = allLogs.find(l => l.log_id === logId);
            if (!log) return;

            const modal = document.getElementById('details-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = `${log.action_type} –≤ ${log.table_display || log.table_name} (ID: ${log.record_id})`;

            let html = `<p><strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</strong> ${log.employee_name}</p>`;
            html += `<p><strong>–î–∞—Ç–∞:</strong> ${new Date(log.created_at).toLocaleString('ru-RU')}</p>`;

            if (log.action_type === 'UPDATE' && log.old_values && log.new_values) {
                html += '<div class="diff-container">';
                html += '<div class="diff-section"><h4>–°—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</h4>';
                for (const [key, value] of Object.entries(log.old_values)) {
                    if (log.new_values[key] !== value) {
                        html += `<div class="diff-item diff-old">${key}: ${JSON.stringify(value)}</div>`;
                    }
                }
                html += '</div>';
                html += '<div class="diff-section"><h4>–ù–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</h4>';
                for (const [key, value] of Object.entries(log.new_values)) {
                    if (log.old_values[key] !== value) {
                        html += `<div class="diff-item diff-new">${key}: ${JSON.stringify(value)}</div>`;
                    }
                }
                html += '</div></div>';
            } else if (log.new_values) {
                html += '<div class="diff-section"><h4>–î–∞–Ω–Ω—ã–µ</h4>';
                html += `<pre>${JSON.stringify(log.new_values, null, 2)}</pre>`;
                html += '</div>';
            } else if (log.old_values) {
                html += '<div class="diff-section"><h4>–£–¥–∞–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h4>';
                html += `<pre>${JSON.stringify(log.old_values, null, 2)}</pre>`;
                html += '</div>';
            }

            body.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('details-modal').style.display = 'none';
        }

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('details-modal');
            if (event.target === modal) {
                closeModal();
            }
        });

        document.addEventListener('DOMContentLoaded', loadAuditLogs);
    </script>
    <script src="/static/theme-switcher.js"></script>
</body>
</html>
